name: Prepare
run-name: 'prepare: environment for `${{ github.ref_name }}`'

on:
  workflow_call:
    outputs:
      deployable:
        value: ${{ jobs.environments.outputs.deployable }}
      deploy-env:
        value: ${{ jobs.environments.outputs.deploy-env }}
      image-tag:
        value: ${{ jobs.environments.outputs.image-tag }}
      repo-name:
        value: ${{ jobs.environments.outputs.repo-name }}
      repo-branch:
        value: ${{ jobs.environments.outputs.branch-name }}

jobs:
  labels:
    name: Labels
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Labeler
        uses: actions/labeler@v6
        with:
          dot: true

  environments:
    name: Environments
    runs-on: ubuntu-latest
    outputs:
      app-version: ${{ steps.repo.outputs.app-version }}
      branch-name: ${{ steps.repo.outputs.branch-name }}
      deployable: ${{ steps.deploy.outputs.deployable }}
      deploy-env: ${{ steps.deploy.outputs.deploy-env }}
      image-tag: ${{ steps.deploy.outputs.image-tag }}
      repo-name: ${{ steps.repo.outputs.repo-name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Repository
        id: repo
        run: |
          # Extract repository name and convert to lowercase
          echo "repo-name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

          # Extract repository branch name
          echo "branch-name=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

          # Extract version number from `package.json` file
          echo "app-version=$(cat package.json | jq -r '.version')" >> $GITHUB_OUTPUT

      - name: Deployment
        id: deploy
        env:
          APP_VERSION: ${{ steps.repo.outputs.app-version }}
          BRANCH_NAME: ${{ steps.repo.outputs.branch-name }}
          DEPLOYABLE: 1
        run: |
          # Generate image tag with timestamp and commit
          echo "image-tag=${APP_VERSION}-${BRANCH_NAME}.${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

          # Set deployment environment
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "deploy-env=${{ inputs.deploy-env }}" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            echo "deploy-env=staging" >> $GITHUB_OUTPUT
          else
            echo "deploy-env=development" >> $GITHUB_OUTPUT
            DEPLOYABLE=0
          fi

          echo "deployable=$DEPLOYABLE" >> $GITHUB_OUTPUT

      - name: Get sha from previous run
        id: previous-run
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ steps.repo.outputs.branch-name }}
        with:
          script: |
            const { owner, repo } = context.repo;

            try {
              const { data: { workflows } } = await github.rest.actions.listRepoWorkflows({ owner, repo });
              const workflow = workflows.find(w => w.name === process.env.GITHUB_WORKFLOW);

              if (workflow) {
                const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRuns({
                  branch: process.env.BRANCH_NAME,
                  workflow_id: workflow.id,
                  status: 'completed',
                  per_page: 1,
                  owner,
                  repo,
                });

                if (workflow_runs.length > 0) {
                  console.log(workflow_runs)
                  core.setOutput('commit-hash', workflow_runs[0].head_commit.id);
                  core.setOutput('commit-msg', workflow_runs[0].head_commit.message);
                }
              }
            } catch (error) {
              core.warning(`Failed to get previous run: ${error.message}`);
            }

      - name: Get changed files
        id: changed-files
        env:
          PREVIOUS_SHA: ${{ steps.previous-run.outputs.commit-hash }}
          CURRENT_SHA: ${{ github.sha }}
        run: |
          if [ -z "$PREVIOUS_SHA" ]; then
            echo "No previous run found. Skipping diff."
            exit 0
          fi

          # Fetch previous commit
          git fetch origin $PREVIOUS_SHA --depth=1

          # Get changed files
          CHANGES=$(git diff --name-only $PREVIOUS_SHA $CURRENT_SHA)

          echo "Changed files:"
          echo "$CHANGES"

          {
            echo "files<<EOF"
            echo "$CHANGES"
            echo "EOF"
          } >> $GITHUB_OUTPUT
