name: Prepare
run-name: 'prepare: environment for `${{ github.ref_name }}`'

on:
  workflow_call:
    outputs:
      buildable:
        value: ${{ jobs.environments.outputs.buildable }}
      deployable:
        value: ${{ jobs.environments.outputs.deployable }}
      deploy-env:
        value: ${{ jobs.environments.outputs.deploy-env }}
      image-tag:
        value: ${{ jobs.environments.outputs.image-tag }}
      prev-sha:
        value: ${{ jobs.environments.outputs.prev-sha }}
      prev-msg:
        value: ${{ jobs.environments.outputs.prev-msg }}
      prev-tag:
        value: ${{ jobs.environments.outputs.prev-tag }}
      repo-name:
        value: ${{ jobs.environments.outputs.repo-name }}
      repo-branch:
        value: ${{ jobs.environments.outputs.branch-name }}

jobs:
  labels:
    name: Labels
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Labeler
        uses: actions/labeler@v6
        with:
          dot: true

  environments:
    name: Environments
    runs-on: ubuntu-latest
    outputs:
      app-version: ${{ steps.repo.outputs.app-version }}
      branch-name: ${{ steps.repo.outputs.branch-name }}
      buildable: ${{ steps.check-build.outputs.buildable }}
      deployable: ${{ steps.deploy.outputs.deployable }}
      deploy-env: ${{ steps.deploy.outputs.deploy-env }}
      image-tag: ${{ steps.deploy.outputs.image-tag }}
      prev-sha: ${{ steps.previous-run.outputs.prev-sha }}
      prev-msg: ${{ steps.previous-run.outputs.prev-msg }}
      prev-tag: ${{ steps.previous-run.outputs.prev-tag }}
      repo-name: ${{ steps.repo.outputs.repo-name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Repository
        id: repo
        run: |
          # Extract repository name and convert to lowercase
          echo "repo-name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

          # Extract repository branch name
          echo "branch-name=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

          # Extract version number from `package.json` file
          echo "app-version=$(cat package.json | jq -r '.version')" >> $GITHUB_OUTPUT

      - name: Deployment
        id: deploy
        env:
          APP_VERSION: ${{ steps.repo.outputs.app-version }}
          BRANCH_NAME: ${{ steps.repo.outputs.branch-name }}
          DEPLOYABLE: 1
        run: |
          # Generate image tag with timestamp and commit
          echo "image-tag=${APP_VERSION}-${BRANCH_NAME}.${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

          # Set deployment environment
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "deploy-env=${{ inputs.deploy-env }}" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            echo "deploy-env=staging" >> $GITHUB_OUTPUT
          else
            echo "deploy-env=development" >> $GITHUB_OUTPUT
            DEPLOYABLE=0
          fi

          echo "deployable=$DEPLOYABLE" >> $GITHUB_OUTPUT

      - name: Get package info
        id: previous-pkgs
        uses: actions/github-script@v7
        continue-on-error: true
        env:
          IMAGE_NAME: ${{ steps.repo.outputs.repo-name }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const package_name = process.env.IMAGE_NAME;

            try {
              const { data } = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                package_type: 'docker',
                package_name,
                org: owner,
              })

              console.log(data)
            } catch (error) {
              console.log(`Failed to get package ${package_name} in ${owner}: ${error.message}`);
              console.error(error)
            }

      - name: Get sha from previous run
        id: previous-run
        uses: actions/github-script@v7
        env:
          APP_VERSION: ${{ steps.repo.outputs.app-version }}
          BRANCH_NAME: ${{ steps.repo.outputs.branch-name }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const version = process.env.APP_VERSION;
            const branch = process.env.BRANCH_NAME;

            try {
              const { data: { workflows } } = await github.rest.actions.listRepoWorkflows({ owner, repo });
              const workflow = workflows.find(w => w.name === process.env.GITHUB_WORKFLOW);

              if (!workflow) return;

              const { data: { workflow_runs } } = await github.rest.actions.listWorkflowRuns({
                branch,
                workflow_id: workflow.id,
                status: 'completed',
                per_page: 1,
                owner,
                repo,
              });

              let prev_sha, prev_msg;
              let image_slug = 'main';

              if (workflow_runs.length > 0) {
                prev_sha = workflow_runs[0].head_commit.id;
                prev_msg = workflow_runs[0].head_commit.message;
                image_slug = branch.replace('/', '-')
              } else {
                const { data: { workflow_runs: workflow_main } } = await github.rest.actions.listWorkflowRuns({
                  branch: image_slug,
                  workflow_id: workflow.id,
                  status: 'completed',
                  conclusion: 'success',
                  per_page: 1,
                  owner,
                  repo,
                });

                if (workflow_main.length > 0) {
                  core.info('No successful run found on main.');
                  return;
                }

                prev_sha = workflow_main[0].head_commit.id;
                prev_msg = workflow_main[0].head_commit.message;

                core.info('No workflow runs found');
              }

              const prev_tag = `${version}-${image_slug}.${prev_sha.substring(0, 8)}`;

              core.setOutput('prev-sha', prev_sha);
              core.setOutput('prev-msg', prev_msg);
              core.setOutput('prev-tag', prev_tag);

              console.log(`Using previous run on ${branch}: ${prev_tag}`);
            } catch (error) {
              core.setFailed(`Failed to get previous run: ${error.message}`);
            }

      - name: Get changed files
        id: changed-files
        uses: actions/github-script@v7
        if: steps.previous-run.outputs.prev-sha != ''
        env:
          PREVIOUS_SHA: ${{ steps.previous-run.outputs.prev-sha }}
          CURRENT_SHA: ${{ github.sha }}
        with:
          script: |
            const prev_sha = process.env.PREVIOUS_SHA.substring(0, 8);
            const curr_sha = process.env.CURRENT_SHA.substring(0, 8);

            try {
              await exec.exec('git', ['fetch', 'origin', prev_sha, '--depth=1', '--quiet']);

              let diffs = '';
              await exec.exec('git', ['diff', '--name-only', prev_sha, curr_sha], {
                listeners: {
                  stdout: (data) => {
                    diffs += data.toString().trim();
                  }
                }
              });

              core.setOutput('files', diffs);
            } catch (error) {
              core.setFailed(`Failed to get changed files: ${error.message}`);
            }

      - name: Check buildability
        id: check-build
        uses: actions/github-script@v7
        if: steps.changed-files.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        with:
          script: |
            const changed_files = process.env.CHANGED_FILES;
            const files = changed_files.split('\n').map(f => f.trim()).filter(f => f.length > 0);

            const patterns = [
              /^database\//,
              /^dockerfiles\//,
              /^public\//,
              /^src\//,
              /^bun\.lock$/,
              /^package\.json$/,
              /^drizzle\.config\.ts$/,
              /^tsconfig\.json$/
            ];

            const buildable = files.some(file => patterns.some(pattern => pattern.test(file)));

            core.debug(`Buildable: ${buildable}`);
            core.setOutput('buildable', buildable ? 1 : 0);
